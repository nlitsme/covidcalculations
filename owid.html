<html>
<head>
<meta charset=utf-8 />
<meta http-equiv=“Pragma” content=”no-cache”>
<meta http-equiv=“Expires” content=”-1″>
<meta http-equiv=“CACHE-CONTROL” content=”NO-CACHE”>
<style>
#controlsdiv {
    position:fixed;
    right:0px;
    top:100px;
    width:120px;
}
#tablediv {
    position:absolute;
    top:140px;
    left:0px;
    right:140px;
}
</style>
<script src="filter.js" ></script>
<script language=javascript><!--


const OWIDURL = "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv";
var mincases = 50;
var minpop = 500000;
var cutoff = 0.10;
var bvalue = 0.1;
var filt = new LowPass(cutoff, bvalue);
function updfilt()
{
    filt = cutoff ? new LowPass(cutoff, bvalue) : null;
}

function el()
{
    if (arguments.length==0)
        throw "el needs at least one argument";
    var tag = arguments[0];
    var e = document.createElement(tag);
    var args = [];
    var attr;
    for (var i=1 ; i<arguments.length ; i++)
    {
        var arg = arguments[i];
        if (arg instanceof Element)
            args.push(arg);
        else if (arg instanceof Map)
            arg.forEach( (v,k)=>e.setAttribute(k, v) );
        else if (typeof(arg) == "string")
            args.push(arg);
        else if (typeof(arg) == "object")
            Object.entries(arg).forEach(([k,v])=>e.setAttribute(k, v))
        else
            throw "unsupported el argument";
    }
    if (args)
        e.replaceChildren(...args);
    return e;
}
function makegraph(values)
{
    var td = el('td');
    var canvas = el('canvas');
    td.append(canvas);

    if (filt)
        values = filt.calc(values);

    var ymax = Math.max(...values);
    var ymin = Math.min(...values);

    values = values.map( y => (y-ymin)/(ymax-ymin) );

    var cvx = (x) => 2*x;

    canvas.width = cvx(values.length);
    canvas.height = 40;

    var cvy = (y) => (canvas.height-5-y*(canvas.height-10));

    var ctx = canvas.getContext("2d");
    ctx.beginPath();
    ctx.moveTo(0, cvy(values[0]));
    for (var x=1 ; x<values.length ; x++)
        ctx.lineTo(cvx(x), cvy(values[x]));
    ctx.stroke();

    return td;
}

function calcdifferences(table)
{
    var res = [];
    var prev;
    for (var ent of table)
    {
        if (prev)
            res.push({
                gevallen:ent.gevallen-prev.gevallen, 
                overleden:ent.overleden-prev.overleden, 
                ziekenhuis:ent.ziekenhuis-prev.ziekenhuis,
                inwoners:ent.inwoners,
            }); 
        prev = ent;
    }
    return res;
}
function makerow(name, data)
{
    var tr = el('tr');

    tr.append(maketexttd(name));

    var table = Object.entries(data).sort().map( ([k,v])=>v );
    var diff = calcdifferences(table);

    var today = table[table.length-1];
    var fourdays = table[table.length-5];
    var lastweek = table[table.length-8];
    var last18 = table[table.length-19];

    tr.append(makenumtd(today.inwoners));
    if (today.inwoners < minpop)
        return;
    tr.append(makenumtd(fmtpct(today.gevallen/today.inwoners*100000)));

    var weekincidence = (today.gevallen/today.inwoners-lastweek.gevallen/lastweek.inwoners)*100000;
    tr.append(makenumtd(fmtpct(weekincidence)));

    if (weekincidence < mincases)
        return;

    var rval = last18 ? (today.gevallen-fourdays.gevallen)/(today.gevallen-last18.gevallen)*18/4 : 0;
    tr.append(makenumtd(fmtpct(rval)));

    tr.append(makegraph(diff.slice(-90, -1).map( e => e.gevallen )));

    var weekincidence = (today.overleden/today.inwoners-lastweek.overleden/lastweek.inwoners)*100000;
    tr.append(makenumtd(fmtpct(weekincidence)));

    tr.append(makegraph(diff.slice(-90, -1).map( e => e.overleden )));

    return tr;
}
function createheader(th)
{
    var headers = [ "Country", "population", "total/100k", "cases<br>/week/100k", "rval", "casegraph", "deaths<br>/week/100k", "deathsgraph" ];

    var tr = th.insertRow(0);
    for (var h of headers) {
        var c = el('th');
        c.innerHTML = h;
        tr.appendChild(c);
    }
}
function makeslider(label, idtag, minvalue, maxvalue, initval, texttoval, valtotext)
{
    var lbl = el('span')
    lbl.innerHTML = label;
    var disp = el('span')
    disp.id = idtag+".value";

    var inp = el('input')
    inp.id = idtag;
    inp.type = "range";
    inp.min = minvalue;
    inp.max = maxvalue;
    inp.value = initval;
    inp.oninput = function() { texttoval(this.value); disp.innerHTML = valtotext(); update(); };
    inp.style.transform = "rotate(90deg)";
    inp.style.width = 100;
    inp.style.height = 100;

    disp.innerHTML = valtotext();

    var div = el('div', {id:idtag+"div"});
    div.append(inp, lbl, disp);
    return div;
}
function makedivsliders()
{
    return [
        makeslider("smoothing:<br>", "cutoff", 0, 500, 140, t => { cutoff = Number(t)/1000; updfilt(); }, () => (1/cutoff).toFixed(1)+" days"),
        makeslider("depth:", "depth", 1, 100, 16, t => { bvalue = 4/Number(t); updfilt(); }, () => (4/bvalue).toFixed(0)),
        makeslider("mincases:", "mincases", 0, 800, 50, t => mincases = Number(t), () => mincases.toFixed(0)),
        makeslider("minpop:", "minpop", 0, 1000, 50, t => minpop = Number(t)*100000, () => (minpop/1000000).toFixed(2)+"M"),
    ];
}


function decodecsv(txt)
{
    var table = [];
    var names;
    for (var line of txt.split("\n")) {
        if (!line) continue;
        fields = line.split(",");
        if (!names)
            names = fields;
        else
            table.push(Object.fromEntries(names.map( (name, i)=> [name, fields[i]] )))
    }
    return table;
}

function bycountrybydate(table)
{
    var dict = {};

    function addto(d, key, date, src)
    {
        if (!rec.total_cases)
            return;
        if (!d[key]) d[key] = { };
        if (!d[key][date]) d[key][date] = { overleden:0, ziekenhuis:0, gevallen:0, inwoners:0 };
        d[key][date].overleden += Number(rec.total_deaths);
        d[key][date].gevallen += Number(rec.total_cases);
        d[key][date].inwoners += Number(rec.population);
    }

    for (rec of table)
    {
        var date = rec.date;
        var name = rec.location;
        if (name)
            addto(dict, name, date, rec);

        var cont = rec.continent;
        if (cont)
            addto(dict, "Continent "+cont, date, rec);
    }
    return dict;
}
function start()
{

    fetch(OWIDURL).then(r => r.text()).then( r => { g_table = bycountrybydate(decodecsv(r)); update(); });

    var div = document.getElementById("controlsdiv");
    div.append(...makedivsliders());

    var div = document.getElementById("tablediv");
    var tab = el('table');
    tab.id = "table";
    createheader(tab.createTHead());
    div.appendChild(tab);

    add_sorter(tab);
}
function fmtdate(t)
{
    var y = t.getFullYear();
    var m = (t.getMonth()+1).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
    var d = t.getDate().toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
    return y+"-"+m+"-"+d;
}
function fmtpct(x)
{
    return x.toFixed(1);
}
function maketexttd(txt)
{
    var td = el('td');
    td.innerHTML = txt;
    return td;
}
function makedatetd(t)
{
    var td = el('td');
    td.innerHTML = fmtdate(t);
    td.style.textAlign = 'center';
    return td;
}

function makenumtd(txt)
{
    var td = el('td');
    td.innerHTML = txt;
    td.style.textAlign = 'right';
    return td;
}

function update()
{
    var tab = document.getElementById('table');
    tab.cellSpacing = 0;
    tab.cellPadding = 5;
    tab.border = true;

    var bodies = [];

    var tbody = el('tbody');
    name = "World";
    data = g_table[name];
    var row = makerow(name, data); if (row) tbody.append(row);
    bodies.push(tbody);

    var tbody = el('tbody');
    Object.entries(g_table).forEach( ([name, data]) => { if (!name.startsWith("Continent")) return; var row = makerow(name, data); if (row) tbody.append(row); } );
    bodies.push(tbody);

    var tbody = el('tbody');
    Object.entries(g_table).forEach( ([name, data]) => { if (name.startsWith("Continent") || name=="World") return; var row = makerow(name, data); if (row) tbody.append(row); } );
    bodies.push(tbody);

    tab.replaceChildren(tab.tHead, ...bodies);

    if (tab.currentsortcolumn)
        sortbycolumn(tab, tab.currentsortcolumn);
}

function sortbycolumn(table, th)
{
    const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;

    const comparer = (idx, asc) => (a, b) => ((v1, v2) => 
        v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
        )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));


    for (var oldtbody of Array.from(table.tBodies)) {
        var newtbody = table.createTBody();
        Array.from(oldtbody.children)
            .sort(comparer(th.colnr, th.asc))
            .forEach(tr => newtbody.append(tr) );
        table.removeChild(oldtbody);
    }
    table.currentsortcolumn = th;
}
function add_sorter(table)
{
    table.currentsortcolumn = null;

    table.querySelectorAll('th').forEach(th => {
        th.colnr = Array.from(th.parentNode.children).indexOf(th);
        th.asc = true;
        th.addEventListener('click', (() => { th.asc = !th.asc; sortbycolumn(table, th); } ))
    });
}

--></script>
</head>
<body onLoad="start()">
    <div>
Data from <a href="https://github.com/owid/covid-19-data/blob/master/public/data/">OurWorldInData</a>.  More tables: <a href="vac.html">vaccinations</a>, <a href="rivm.html">Dutch municipalities</a>.<br>
<br>
This table shows the current Covid-19 infection levels of all countries and continents.
Click table headers to sort, slide the filter to smooth the graphs, slide 'cutoff' up to turn off smoothing filter, use `mincases` and `minpop` to show less entries.<br><p>
Created by Willem Hengeveld &lt;<a href="mailto:itsme@xs4all.nl">itsme@xs4all.nl</a>&gt;, <a href="https://itsme.home.xs4all.nl/">homepage</a>.
    </div>

    <div id="controlsdiv"></div>
    <div id="tablediv"></div>

</body>
</html>
